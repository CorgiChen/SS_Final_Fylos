{"version":3,"sources":["assets\\Script\\ChatBubbleController.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class ChatBubbleController extends cc.Component {\n    @property(cc.Node)\n    player: cc.Node = null;\n\n    @property(cc.Node)\n    friend: cc.Node = null;\n\n    @property(cc.SpriteFrame)\n    bubbleSpriteFrame: cc.SpriteFrame = null;\n\n    @property([cc.SpriteFrame])\n    chatImageSpriteFrames: cc.SpriteFrame[] = [];\n\n    @property\n    followCamera: boolean = true;\n\n    private chatBubble: cc.Node = null;\n    private chatImage: cc.Node = null;\n    private currentImageIndex: number = 0;\n    private readonly DETECTION_RADIUS: number = 200;\n    private readonly BUBBLE_OFFSET: number = 120;\n    private lastBubbleState: boolean = false;\n\n    onLoad() {\n        if (!this.player || !this.friend || !this.bubbleSpriteFrame || this.chatImageSpriteFrames.length === 0) {\n            cc.error(\"Please assign all required components!\");\n            return;\n        }\n\n        // 關閉碰撞區域的顯示\n        const physicsManager = cc.director.getPhysicsManager();\n        if (physicsManager) {\n            physicsManager.debugDrawFlags = 0;\n        }\n\n        this.createChatBubble();\n        this.createChatImage();\n    }\n\n    private createChatBubble() {\n        // 創建一個新的節點作為氣泡\n        this.chatBubble = new cc.Node('Chat_Bubble');\n        \n        // 添加 Sprite 組件\n        const sprite = this.chatBubble.addComponent(cc.Sprite);\n        sprite.spriteFrame = this.bubbleSpriteFrame;\n        \n        // 添加按鈕組件\n        const button = this.chatBubble.addComponent(cc.Button);\n        \n        // 設置父節點\n        this.chatBubble.parent = this.friend;\n        \n        // 設置聊天氣泡的初始位置（在朋友頭頂上方）\n        this.chatBubble.y = this.BUBBLE_OFFSET;\n\n        // 確保氣泡在最上層\n        this.chatBubble.zIndex = 999;\n        \n        // 初始時隱藏聊天氣泡\n        this.chatBubble.active = false;\n\n        // 添加點擊事件\n        this.chatBubble.on(cc.Node.EventType.TOUCH_END, this.onBubbleClicked, this);\n    }\n\n    private createChatImage() {\n        // 創建聊天圖片節點\n        this.chatImage = new cc.Node('Chat_Image');\n\n        // 添加 Sprite 組件\n        const sprite = this.chatImage.addComponent(cc.Sprite);\n        sprite.spriteFrame = this.chatImageSpriteFrames[0];\n        \n        // 設置父節點為 Canvas\n        this.chatImage.parent = cc.director.getScene().getChildByName('Canvas');\n        \n        // 初始時隱藏圖片\n        this.chatImage.active = false;\n\n        // 確保圖片在最上層\n        this.chatImage.zIndex = 1000;\n\n        // 添加點擊事件（點擊圖片時顯示下一張或隱藏）\n        this.chatImage.on(cc.Node.EventType.TOUCH_END, this.onImageClicked, this);\n    }\n\n    private onBubbleClicked() {\n        if (this.chatImage) {\n            this.currentImageIndex = 0;\n            const sprite = this.chatImage.getComponent(cc.Sprite);\n            if (sprite) {\n                sprite.spriteFrame = this.chatImageSpriteFrames[this.currentImageIndex];\n            }\n            this.chatImage.active = true;\n        }\n    }\n\n    private onImageClicked() {\n        if (this.chatImage) {\n            this.currentImageIndex++;\n            if (this.currentImageIndex < this.chatImageSpriteFrames.length) {\n                // 顯示下一張圖片\n                const sprite = this.chatImage.getComponent(cc.Sprite);\n                if (sprite) {\n                    sprite.spriteFrame = this.chatImageSpriteFrames[this.currentImageIndex];\n                }\n            } else {\n                // 已經是最後一張圖片，隱藏聊天圖片\n                this.chatImage.active = false;\n                this.currentImageIndex = 0;\n            }\n        }\n    }\n\n    update() {\n        if (!this.player || !this.friend || !this.chatBubble) return;\n\n        if (this.followCamera) {\n            const camera = cc.director.getScene().getChildByName('Canvas').getChildByName('Main Camera');\n            this.chatImage.x = camera.x;\n        }\n\n        // 將 Vec3 轉換為 Vec2\n        const playerPos = new cc.Vec2(this.player.position.x, this.player.position.y);\n        const friendPos = new cc.Vec2(this.friend.position.x, this.friend.position.y);\n\n        // 計算玩家和朋友的距離\n        const distance = this.getDistance(playerPos, friendPos);\n        const shouldShow = distance <= this.DETECTION_RADIUS;\n\n        // 根據距離顯示或隱藏聊天氣泡\n        if (this.chatBubble.active !== shouldShow) {\n            this.chatBubble.active = shouldShow;\n            if (shouldShow) {\n                // 確保氣泡在最上層\n                this.chatBubble.zIndex = 999;\n            }\n        }\n    }\n\n    private getDistance(pos1: cc.Vec2, pos2: cc.Vec2): number {\n        const dx = pos1.x - pos2.x;\n        const dy = pos1.y - pos2.y;\n        return Math.sqrt(dx * dx + dy * dy);\n    }\n\n    onDestroy() {\n        if (this.chatBubble) {\n            this.chatBubble.off(cc.Node.EventType.TOUCH_END, this.onBubbleClicked, this);\n            this.chatBubble.destroy();\n        }\n        if (this.chatImage) {\n            this.chatImage.off(cc.Node.EventType.TOUCH_END, this.onImageClicked, this);\n            this.chatImage.destroy();\n        }\n    }\n} "]}