{"version":3,"sources":["assets\\Script\\ChatBubbleController.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const { ccclass, property } = cc._decorator;\r\nimport AudioManager from './AudioManager';\r\n\r\n@ccclass\r\nexport default class ChatBubbleController extends cc.Component {\r\n    @property(cc.Node)\r\n    player: cc.Node = null;\r\n\r\n    @property(cc.Node)\r\n    friend: cc.Node = null;\r\n\r\n    @property(cc.SpriteFrame)\r\n    bubbleSpriteFrame: cc.SpriteFrame = null;\r\n\r\n    @property([cc.SpriteFrame])\r\n    chatImageSpriteFrames: cc.SpriteFrame[] = [];\r\n\r\n    @property\r\n    followCamera: boolean = true;\r\n\r\n    @property(cc.AudioClip)\r\n    openSound: cc.AudioClip = null;\r\n\r\n    private chatBubble: cc.Node = null;\r\n    private chatImage: cc.Node = null;\r\n    private currentImageIndex: number = 0;\r\n    private readonly DETECTION_RADIUS: number = 200;\r\n    private readonly BUBBLE_OFFSET: number = 120;\r\n    private lastBubbleState: boolean = false;\r\n\r\n    onLoad() {\r\n        if (!this.player || !this.friend || !this.bubbleSpriteFrame || this.chatImageSpriteFrames.length === 0) {\r\n            cc.error(\"Please assign all required components!\");\r\n            return;\r\n        }\r\n\r\n        // 關閉碰撞區域的顯示\r\n        const physicsManager = cc.director.getPhysicsManager();\r\n        if (physicsManager) {\r\n            physicsManager.debugDrawFlags = 0;\r\n        }\r\n\r\n        this.createChatBubble();\r\n        this.createChatImage();\r\n    }\r\n\r\n    private createChatBubble() {\r\n        // 創建一個新的節點作為氣泡\r\n        this.chatBubble = new cc.Node('Chat_Bubble');\r\n        \r\n        // 添加 Sprite 組件\r\n        const sprite = this.chatBubble.addComponent(cc.Sprite);\r\n        sprite.spriteFrame = this.bubbleSpriteFrame;\r\n        \r\n        // 添加按鈕組件\r\n        const button = this.chatBubble.addComponent(cc.Button);\r\n        \r\n        // 設置父節點\r\n        this.chatBubble.parent = this.friend;\r\n        \r\n        // 設置聊天氣泡的初始位置（在朋友頭頂上方）\r\n        this.chatBubble.y = this.BUBBLE_OFFSET;\r\n\r\n        // 確保氣泡在最上層\r\n        this.chatBubble.zIndex = 999;\r\n        \r\n        // 初始時隱藏聊天氣泡\r\n        this.chatBubble.active = false;\r\n\r\n        // 添加點擊事件\r\n        this.chatBubble.on(cc.Node.EventType.TOUCH_END, this.onBubbleClicked, this);\r\n    }\r\n\r\n    private createChatImage() {\r\n        // 創建聊天圖片節點\r\n        this.chatImage = new cc.Node('Chat_Image');\r\n\r\n        // 添加 Sprite 組件\r\n        const sprite = this.chatImage.addComponent(cc.Sprite);\r\n        sprite.spriteFrame = this.chatImageSpriteFrames[0];\r\n        \r\n        // 設置父節點為 Canvas\r\n        this.chatImage.parent = cc.director.getScene().getChildByName('Canvas');\r\n        \r\n        // 初始時隱藏圖片\r\n        this.chatImage.active = false;\r\n\r\n        // 確保圖片在最上層\r\n        this.chatImage.zIndex = 1000;\r\n\r\n        // 添加點擊事件（點擊圖片時顯示下一張或隱藏）\r\n        this.chatImage.on(cc.Node.EventType.TOUCH_END, this.onImageClicked, this);\r\n    }\r\n\r\n    private onBubbleClicked() {\r\n        if (this.chatImage) {\r\n            this.currentImageIndex = 0;\r\n            const sprite = this.chatImage.getComponent(cc.Sprite);\r\n            if (sprite) {\r\n                sprite.spriteFrame = this.chatImageSpriteFrames[this.currentImageIndex];\r\n            }\r\n            this.chatImage.active = true;\r\n            // 播放 Open.mp3 音效，音量設為 5\r\n            if (this.openSound) {\r\n                cc.audioEngine.setVolume(cc.audioEngine.playEffect(this.openSound, false), cc.audioEngine.getVolume(AudioManager.audioId));\r\n            }\r\n        }\r\n    }\r\n\r\n    private onImageClicked() {\r\n        if (this.chatImage) {\r\n            this.currentImageIndex++;\r\n            if (this.currentImageIndex < this.chatImageSpriteFrames.length) {\r\n                // 顯示下一張圖片\r\n                const sprite = this.chatImage.getComponent(cc.Sprite);\r\n                if (sprite) {\r\n                    sprite.spriteFrame = this.chatImageSpriteFrames[this.currentImageIndex];\r\n                }\r\n            } else {\r\n                // 已經是最後一張圖片，隱藏聊天圖片\r\n                this.chatImage.active = false;\r\n                this.currentImageIndex = 0;\r\n            }\r\n        }\r\n    }\r\n\r\n    update() {\r\n        if (!this.player || !this.friend || !this.chatBubble) return;\r\n\r\n        if (this.followCamera) {\r\n            const camera = cc.director.getScene().getChildByName('Canvas').getChildByName('Main Camera');\r\n            this.chatImage.x = camera.x;\r\n        }\r\n\r\n        // 將 Vec3 轉換為 Vec2\r\n        const playerPos = new cc.Vec2(this.player.position.x, this.player.position.y);\r\n        const friendPos = new cc.Vec2(this.friend.position.x, this.friend.position.y);\r\n\r\n        // 計算玩家和朋友的距離\r\n        const distance = this.getDistance(playerPos, friendPos);\r\n        const shouldShow = distance <= this.DETECTION_RADIUS;\r\n\r\n        // 根據距離顯示或隱藏聊天氣泡\r\n        if (this.chatBubble.active !== shouldShow) {\r\n            this.chatBubble.active = shouldShow;\r\n            if (shouldShow) {\r\n                // 確保氣泡在最上層\r\n                this.chatBubble.zIndex = 999;\r\n            }\r\n        }\r\n    }\r\n\r\n    private getDistance(pos1: cc.Vec2, pos2: cc.Vec2): number {\r\n        const dx = pos1.x - pos2.x;\r\n        const dy = pos1.y - pos2.y;\r\n        return Math.sqrt(dx * dx + dy * dy);\r\n    }\r\n\r\n    onDestroy() {\r\n        if (this.chatBubble) {\r\n            this.chatBubble.off(cc.Node.EventType.TOUCH_END, this.onBubbleClicked, this);\r\n            this.chatBubble.destroy();\r\n        }\r\n        if (this.chatImage) {\r\n            this.chatImage.off(cc.Node.EventType.TOUCH_END, this.onImageClicked, this);\r\n            this.chatImage.destroy();\r\n        }\r\n    }\r\n} "]}