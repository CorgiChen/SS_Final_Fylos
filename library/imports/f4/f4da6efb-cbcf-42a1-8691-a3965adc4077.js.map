{"version":3,"sources":["assets\\Script\\Player.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\n//  - https://docs.cocos.com/creator/manual/en/scripting/typescript.html\n// Learn Attribute:\n//  - https://docs.cocos.com/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - https://docs.cocos.com/creator/manual/en/scripting/life-cycle-callbacks.html\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class PlayerController extends cc.Component {\n    moveSpeed: number = 300;\n    jumpForce: number = 800;\n    gravity: number = 1200;\n    maxFallSpeed: number = 800;\n    groundY: number = -300;\n\n    public moveDirection: number = 0;\n    private onGround: boolean = false;\n    private isJumping: boolean = false;\n    private isFalling: boolean = false;\n    private anim: cc.Animation = null;\n    private verticalVelocity: number = 0;\n    private horizontalVelocity: number = 0;\n    private rigidbody: cc.RigidBody = null;\n    private collider: cc.PhysicsBoxCollider = null;\n    private currentAnimation: string = \"idle\";\n    private groundCheckDistance: number = 10;\n    private lastVerticalVelocity: number = 0;  // 用於檢測速度方向變化\n\n    onLoad() {\n        // 初始化物理系統\n        const manager = cc.director.getPhysicsManager();\n        manager.enabled = true;\n        manager.gravity = cc.v2(0, -1200);\n        manager.debugDrawFlags = cc.PhysicsManager.DrawBits.e_aabbBit |\n            cc.PhysicsManager.DrawBits.e_shapeBit;\n\n        // 獲取組件\n        this.anim = this.getComponent(cc.Animation);\n        if (this.anim) {\n            const clips = this.anim.getClips();\n            clips.forEach(clip => {\n                clip.wrapMode = cc.WrapMode.Loop;\n            });\n        }\n\n        // 初始化物理組件\n        this.rigidbody = this.getComponent(cc.RigidBody);\n        this.collider = this.getComponent(cc.PhysicsBoxCollider);\n\n        if (this.rigidbody) {\n            this.rigidbody.type = cc.RigidBodyType.Dynamic;\n            this.rigidbody.fixedRotation = true;\n            this.rigidbody.enabledContactListener = true;\n            this.rigidbody.gravityScale = 0;\n            this.rigidbody.linearDamping = 0;\n            this.rigidbody.allowSleep = false;\n        }\n\n        if (this.collider) {\n            this.collider.enabled = true;\n            this.collider.sensor = false;\n            this.collider.friction = 0.3;\n            this.collider.restitution = 0;\n\n            // 調整碰撞箱大小\n            const size = this.node.getContentSize();\n            this.collider.size = cc.size(size.width * 0.8, size.height * 0.8);\n            this.collider.offset = cc.v2(0, -size.height * 0.1);\n        }\n\n        // 註冊鍵盤事件\n        cc.systemEvent.on(cc.SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\n        cc.systemEvent.on(cc.SystemEvent.EventType.KEY_UP, this.onKeyUp, this);\n\n        // 預設播放待機動畫\n        if (this.anim) {\n            this.anim.play(\"idle\");\n        }\n    }\n\n    private playAnimation(animName: string) {\n        if (this.anim && this.currentAnimation !== animName) {\n            const state = this.anim.getAnimationState(animName);\n            if (state) {\n                state.wrapMode = cc.WrapMode.Loop;\n                state.speed = 1.0;\n                this.anim.play(animName);\n                this.currentAnimation = animName;\n            }\n        }\n    }\n\n    onKeyDown(event: cc.Event.EventKeyboard) {\n        switch (event.keyCode) {\n            case cc.macro.KEY.left:\n            case cc.macro.KEY.a:\n                this.moveDirection = -1;\n                this.horizontalVelocity = -this.moveSpeed;\n                if (!this.isJumping) {\n                    this.playAnimation(\"move\");\n                }\n                if (this.node.scaleX > 0) {\n                    this.node.scaleX *= -1;\n                }\n                break;\n            case cc.macro.KEY.right:\n            case cc.macro.KEY.d:\n                this.moveDirection = 1;\n                this.horizontalVelocity = this.moveSpeed;\n                if (!this.isJumping) {\n                    this.playAnimation(\"move\");\n                }\n                if (this.node.scaleX < 0) {\n                    this.node.scaleX *= -1;\n                }\n                break;\n            case cc.macro.KEY.up:\n            case cc.macro.KEY.space:\n                if (this.onGround) {\n                    this.jump();\n                }\n                break;\n        }\n    }\n\n    onKeyUp(event: cc.Event.EventKeyboard) {\n        switch (event.keyCode) {\n            case cc.macro.KEY.left:\n            case cc.macro.KEY.a:\n                if (this.moveDirection < 0) {\n                    this.moveDirection = 0;\n                    this.horizontalVelocity = 0;\n                    if (!this.isJumping) {\n                        this.playAnimation(\"idle\");\n                    }\n                }\n                break;\n            case cc.macro.KEY.right:\n            case cc.macro.KEY.d:\n                if (this.moveDirection > 0) {\n                    this.moveDirection = 0;\n                    this.horizontalVelocity = 0;\n                    if (!this.isJumping) {\n                        this.playAnimation(\"idle\");\n                    }\n                }\n                break;\n        }\n    }\n\n    jump() {\n        if (this.onGround) {\n            this.onGround = false;\n            this.isJumping = true;\n            this.isFalling = false;\n            this.verticalVelocity = this.jumpForce;\n            this.playAnimation(\"jump\");\n        }\n    }\n\n    onBeginContact(contact: cc.PhysicsContact, selfCollider: cc.PhysicsCollider, otherCollider: cc.PhysicsCollider) {\n        if (otherCollider.node.name === 'Ground') {\n            const normal = contact.getWorldManifold().normal;\n            \n            if (normal.y < 0) {\n                this.onGround = true;\n                this.isJumping = false;\n                this.isFalling = false;\n                this.verticalVelocity = 0;\n\n                if (this.moveDirection !== 0) {\n                    this.playAnimation(\"move\");\n                } else {\n                    this.playAnimation(\"idle\");\n                }\n            }\n        }\n    }\n\n    onEndContact(contact: cc.PhysicsContact, selfCollider: cc.PhysicsCollider, otherCollider: cc.PhysicsCollider) {\n        if (otherCollider.node.name === 'Ground') {\n            const normal = contact.getWorldManifold().normal;\n            \n            if (normal.y < 0) {\n                this.onGround = false;\n                if (this.verticalVelocity < 0) {\n                    this.isFalling = true;\n                    this.playAnimation(\"fall\");\n                }\n            }\n        }\n    }\n\n    update(dt: number) {\n        // 檢查是否在地面上\n        if (!this.onGround) {\n            const startPos = cc.v2(this.node.position.x, this.node.position.y);\n            const rayStart = cc.v2(startPos.x, startPos.y);\n            const rayEnd = cc.v2(startPos.x, startPos.y - this.groundCheckDistance);\n\n            const results = cc.director.getPhysicsManager().rayCast(rayStart, rayEnd, cc.RayCastType.All);\n            if (results.length > 0) {\n                for (const result of results) {\n                    if (result.collider.node.name === 'Ground') {\n                        // 確保只有在地面Y座標附近才判定為著地\n                        if (Math.abs(result.point.y - this.groundY) < 10) {\n                            this.onGround = true;\n                            this.isFalling = false;\n                            this.isJumping = false;\n                            this.verticalVelocity = 0;\n                            this.node.y = this.groundY;  // 確保角色位置正確\n                            break;\n                        }\n                    }\n                }\n            }\n        }\n\n        // 應用重力\n        if (!this.onGround) {\n            this.verticalVelocity -= this.gravity * dt;\n            if (this.verticalVelocity < -this.maxFallSpeed) {\n                this.verticalVelocity = -this.maxFallSpeed;\n            }\n\n            // 檢測跳躍到最高點\n            if (this.lastVerticalVelocity > 0 && this.verticalVelocity <= 0) {\n                this.isJumping = false;\n                this.isFalling = true;\n                this.playAnimation(\"fall\");\n            }\n\n            // 更新下落狀態\n            if (this.verticalVelocity < 0 && !this.isFalling) {\n                this.isFalling = true;\n                this.isJumping = false;\n                this.playAnimation(\"fall\");\n            }\n        }\n\n        // 更新位置\n        let newX = this.node.x + this.horizontalVelocity * dt;\n        let newY = this.node.y + this.verticalVelocity * dt;\n\n        // 防止角色掉出地面\n        if (newY < this.groundY) {\n            newY = this.groundY;\n            this.onGround = true;\n            this.isFalling = false;\n            this.isJumping = false;\n            this.verticalVelocity = 0;\n        }\n\n        this.node.setPosition(newX, newY);\n\n        // 更新動畫\n        if (this.anim) {\n            if (this.isJumping) {\n                this.playAnimation(\"jump\");\n            } else if (this.isFalling) {\n                this.playAnimation(\"fall\");\n            } else if (this.moveDirection !== 0) {\n                this.playAnimation(\"move\");\n            } else {\n                this.playAnimation(\"idle\");\n            }\n        }\n\n        // 保存當前垂直速度用於下一幀比較\n        this.lastVerticalVelocity = this.verticalVelocity;\n    }\n\n    onDestroy() {\n        cc.systemEvent.off(cc.SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\n        cc.systemEvent.off(cc.SystemEvent.EventType.KEY_UP, this.onKeyUp, this);\n    }\n}\n"]}