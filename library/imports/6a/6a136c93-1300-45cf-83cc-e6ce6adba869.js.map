{"version":3,"sources":["assets\\Script\\TimeController.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class ChatBubbleController extends cc.Component {\n    @property(cc.Node)\n    player: cc.Node = null;\n\n    @property(cc.Node)\n    friend: cc.Node = null;\n\n    @property(cc.SpriteFrame)\n    bubbleSpriteFrame: cc.SpriteFrame = null;\n\n    @property([cc.SpriteFrame])\n    chatImageSpriteFrames: cc.SpriteFrame[] = [];\n\n    @property\n    followCamera: boolean = true;\n\n    @property(cc.TTFFont)\n    timeFont: cc.TTFFont = null;\n\n    private chatBubble: cc.Node = null;\n    private chatImage: cc.Node = null;\n    private currentImageIndex: number = 0;\n    private readonly DETECTION_RADIUS: number = 200;\n    private readonly BUBBLE_OFFSET: number = 120;\n    private lastBubbleState: boolean = false;\n    private timeLabel: cc.Node = null;\n\n    onLoad() {\n        if (!this.player || !this.friend || !this.bubbleSpriteFrame || this.chatImageSpriteFrames.length === 0) {\n            cc.error(\"Please assign all required components!\");\n            return;\n        }\n\n        // 關閉碰撞區域的顯示\n        const physicsManager = cc.director.getPhysicsManager();\n        if (physicsManager) {\n            physicsManager.debugDrawFlags = 0;\n        }\n\n        this.createChatBubble();\n        this.createChatImage();\n    }\n\n    private createChatBubble() {\n        // 創建一個新的節點作為氣泡\n        this.chatBubble = new cc.Node('Chat_Bubble');\n        \n        // 添加 Sprite 組件\n        const sprite = this.chatBubble.addComponent(cc.Sprite);\n        sprite.spriteFrame = this.bubbleSpriteFrame;\n        \n        // 添加按鈕組件\n        const button = this.chatBubble.addComponent(cc.Button);\n        \n        // 設置父節點\n        this.chatBubble.parent = this.friend;\n        \n        // 設置聊天氣泡的初始位置（在朋友頭頂上方）\n        this.chatBubble.y = this.BUBBLE_OFFSET;\n\n        // 確保氣泡在最上層\n        this.chatBubble.zIndex = 999;\n        \n        // 初始時隱藏聊天氣泡\n        this.chatBubble.active = false;\n\n        // 添加點擊事件\n        this.chatBubble.on(cc.Node.EventType.TOUCH_END, this.onBubbleClicked, this);\n    }\n\n    private createChatImage() {\n        // 創建聊天圖片節點\n        this.chatImage = new cc.Node('Chat_Image');\n\n        // 添加 Sprite 組件\n        const sprite = this.chatImage.addComponent(cc.Sprite);\n        sprite.spriteFrame = this.chatImageSpriteFrames[0];\n        \n        // 設置父節點為 Canvas\n        this.chatImage.parent = cc.director.getScene().getChildByName('Canvas');\n        \n        // 初始時隱藏圖片\n        this.chatImage.active = false;\n\n        // 確保圖片在最上層\n        this.chatImage.zIndex = 1000;\n\n        // 添加點擊事件（點擊圖片時顯示下一張或隱藏）\n        this.chatImage.on(cc.Node.EventType.TOUCH_END, this.onImageClicked, this);\n    }\n\n    private showCurrentTime() {\n        // 如果已經有 label，先移除\n        if (this.timeLabel && cc.isValid(this.timeLabel)) {\n            this.timeLabel.destroy();\n        }\n        // 創建 label\n        this.timeLabel = new cc.Node('TimeLabel');\n        const label = this.timeLabel.addComponent(cc.Label);\n        // 設定字型大小、顏色\n        label.fontSize = 60; // 字體大小\n        label.lineHeight = 100; // 行高略大於字體\n        label.string = this.getCurrentTimeString();\n        label.horizontalAlign = cc.Label.HorizontalAlign.CENTER;\n        label.verticalAlign = cc.Label.VerticalAlign.CENTER;\n        this.timeLabel.color = cc.Color.WHITE;\n        // 設 parent 跟圖片一樣\n        this.timeLabel.parent = this.chatImage.parent;\n        // 設定在圖片上方 (0, 120) 或正中央 (0, 0)\n        this.timeLabel.setPosition(0, 60);\n        this.timeLabel.zIndex = 1500;\n        this.timeLabel.active = true;\n        if (this.timeFont) {\n            label.font = this.timeFont;\n        }\n    }\n\n    private hideCurrentTime() {\n        if (this.timeLabel && cc.isValid(this.timeLabel)) {\n            this.timeLabel.destroy();\n            this.timeLabel = null;\n        }\n    }\n\n    private getCurrentTimeString(): string {\n        const now = new Date();\n        const pad = (n: number) => n < 10 ? '0' + n : n;\n        const dateStr = ` ${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} `;\n        const timeStr = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;\n        return `${dateStr}\\n${timeStr}`;\n    }\n\n    private onBubbleClicked() {\n        if (this.chatImage) {\n            this.currentImageIndex = 0;\n            const sprite = this.chatImage.getComponent(cc.Sprite);\n            if (sprite) {\n                sprite.spriteFrame = this.chatImageSpriteFrames[this.currentImageIndex];\n            }\n            this.chatImage.active = true;\n            this.showCurrentTime();\n        }\n    }\n\n    private onImageClicked() {\n        if (this.chatImage) {\n            this.currentImageIndex++;\n            if (this.currentImageIndex < this.chatImageSpriteFrames.length) {\n                const sprite = this.chatImage.getComponent(cc.Sprite);\n                if (sprite) {\n                    sprite.spriteFrame = this.chatImageSpriteFrames[this.currentImageIndex];\n                }\n            } else {\n                this.chatImage.active = false;\n                this.currentImageIndex = 0;\n                this.hideCurrentTime();\n            }\n        }\n    }\n\n    update() {\n        if (!this.player || !this.friend || !this.chatBubble) return;\n\n        if (this.followCamera) {\n            const camera = cc.director.getScene().getChildByName('Canvas').getChildByName('Main Camera');\n            this.chatImage.x = camera.x;\n        }\n\n        // 若時間Label存在且顯示中，持續更新時間文字\n        if (this.timeLabel && this.timeLabel.active) {\n            const label = this.timeLabel.getComponent(cc.Label);\n            if (label) {\n                label.string = this.getCurrentTimeString();\n            }\n        }\n\n        // 將 Vec3 轉換為 Vec2\n        const playerPos = new cc.Vec2(this.player.position.x, this.player.position.y);\n        const friendPos = new cc.Vec2(this.friend.position.x, this.friend.position.y);\n\n        // 計算玩家和朋友的距離\n        const distance = this.getDistance(playerPos, friendPos);\n        const shouldShow = distance <= this.DETECTION_RADIUS;\n\n        // 根據距離顯示或隱藏聊天氣泡\n        if (this.chatBubble.active !== shouldShow) {\n            this.chatBubble.active = shouldShow;\n            if (shouldShow) {\n                // 確保氣泡在最上層\n                this.chatBubble.zIndex = 999;\n            }\n        }\n    }\n\n    private getDistance(pos1: cc.Vec2, pos2: cc.Vec2): number {\n        const dx = pos1.x - pos2.x;\n        const dy = pos1.y - pos2.y;\n        return Math.sqrt(dx * dx + dy * dy);\n    }\n\n    onDestroy() {\n        if (this.chatBubble) {\n            this.chatBubble.off(cc.Node.EventType.TOUCH_END, this.onBubbleClicked, this);\n            this.chatBubble.destroy();\n        }\n        if (this.chatImage) {\n            this.chatImage.off(cc.Node.EventType.TOUCH_END, this.onImageClicked, this);\n            this.chatImage.destroy();\n        }\n        this.hideCurrentTime();\n    }\n} "]}